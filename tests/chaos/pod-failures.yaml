---
# Chaos Mesh: Pod Failure Tests
# Tests system resilience when pods are killed randomly

apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: kill-control-api-pod
  namespace: sentinel-system
spec:
  action: pod-kill
  mode: one
  selector:
    labelSelectors:
      app: control-api
  scheduler:
    cron: '@every 10m'
  duration: '30s'

---
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: kill-pipeline-controller-pod
  namespace: sentinel-system
spec:
  action: pod-kill
  mode: one
  selector:
    labelSelectors:
      app: pipeline-controller
  scheduler:
    cron: '@every 15m'
  duration: '30s'

---
# Test: API continues to serve requests during pod restarts
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: api-resilience-test
  namespace: sentinel-system
spec:
  entry: pod-failure-recovery
  templates:
    - name: pod-failure-recovery
      templateType: Serial
      deadline: 5m
      children:
        - kill-api-pod
        - wait-for-restart
        - verify-api-healthy
        - verify-no-data-loss

    - name: kill-api-pod
      templateType: PodChaos
      deadline: 1m
      podChaos:
        action: pod-kill
        mode: one
        selector:
          labelSelectors:
            app: control-api

    - name: wait-for-restart
      templateType: Suspend
      deadline: 2m
      suspend:
        duration: 60s

    - name: verify-api-healthy
      templateType: Task
      deadline: 1m
      task:
        container:
          name: verify
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              curl -f http://control-api:8000/health || exit 1
              echo "✓ Control API is healthy"

    - name: verify-no-data-loss
      templateType: Task
      deadline: 1m
      task:
        container:
          name: verify
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Check workloads endpoint returns data
              curl -f http://control-api:8000/api/v1/workloads || exit 1
              echo "✓ No data loss detected"

---
# Test: Entire service restarts (simulates deployment update)
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: rolling-restart-control-api
  namespace: sentinel-system
spec:
  action: pod-kill
  mode: all
  selector:
    labelSelectors:
      app: control-api
  duration: '2m'

---
# Test: Pod failures during high load
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: failure-under-load
  namespace: sentinel-system
spec:
  entry: load-and-chaos
  templates:
    - name: load-and-chaos
      templateType: Parallel
      deadline: 10m
      children:
        - generate-load
        - random-pod-failures

    - name: generate-load
      templateType: Task
      deadline: 10m
      task:
        container:
          name: load-generator
          image: williamyeh/hey:latest
          command:
            - hey
            - -z
            - 10m
            - -c
            - '50'
            - -q
            - '10'
            - http://control-api:8000/api/v1/workloads

    - name: random-pod-failures
      templateType: PodChaos
      deadline: 10m
      podChaos:
        action: pod-kill
        mode: one
        selector:
          labelSelectors:
            app: control-api
        scheduler:
          cron: '@every 2m'
